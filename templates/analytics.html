{% extends "base.html" %}

{% block content %}
<section class="section container analytics-section">
  <div class="analytics-inner">
    <header class="analytics-header">
      <h2>Platform Analytics</h2>
      <p class="muted">Quick, up-to-date metrics for the platform ‚Äî bookings, revenue and host ratings.</p>
    </header>

    <div class="analytics-grid">
      <div class="stat-card">
        <div class="stat-top">
          <div class="stat-icon">üìà</div>
          <div>
            <div class="stat-value" data-target="{{ data.analytics.total_bookings or 1247 }}">0</div>
            <div class="stat-label">Total Bookings</div>
          </div>
        </div>
        <div class="sparkline">
          <span style="--h:24%"></span><span style="--h:46%"></span><span style="--h:36%"></span><span style="--h:62%"></span><span style="--h:40%"></span><span style="--h:72%"></span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-top">
          <div class="stat-icon">üí∞</div>
          <div>
            <div class="stat-value" data-target="{{ data.analytics.revenue or 1850000 }}">0</div>
            <div class="stat-label">Revenue (‚Çπ)</div>
          </div>
        </div>
        <div class="sparkline">
          <span style="--h:34%"></span><span style="--h:52%"></span><span style="--h:48%"></span><span style="--h:68%"></span><span style="--h:58%"></span><span style="--h:86%"></span>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-top">
          <div class="stat-icon">‚≠ê</div>
          <div>
            <div class="stat-value" data-target="{{ data.analytics.avg_rating or 4.8 }}">0</div>
            <div class="stat-label">Average Rating</div>
          </div>
        </div>
        <div class="sparkline">
          <span style="--h:60%"></span><span style="--h:72%"></span><span style="--h:78%"></span><span style="--h:84%"></span><span style="--h:80%"></span><span style="--h:86%"></span>
        </div>
      </div>
    </div>

    <div class="analytics-footer">
      <p class="muted">Last refreshed: <strong>{{ now().strftime('%Y-%m-%d %H:%M UTC') }}</strong></p>
      <div class="small-actions">
        <button class="btn small">Export CSV</button>
        <button class="btn small outline">Refresh</button>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block scripts %}
<script>
  // Animate numeric counters (works for integers and floats)
  (function() {
    function animateNumber(el, target, duration=1000, isFloat=false) {
      const start = 0;
      const startTime = performance.now();
      const fmt = isFloat ? (v => (v/100).toFixed(1)) : (v => Math.round(v).toLocaleString());
      const multiplier = isFloat ? 100 : 1;

      function step(now){
        const t = Math.min(1, (now - startTime) / duration);
        const eased = t < 0.5 ? 2*t*t : -1 + (4-2*t)*t; // quick ease
        const current = Math.round((start + (target - start) * eased) * multiplier) / multiplier;
        el.textContent = isFloat ? current.toFixed(1) : fmt(current);
        if (t < 1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    document.addEventListener('DOMContentLoaded', function(){
      document.querySelectorAll('.stat-value').forEach(el => {
        const raw = el.getAttribute('data-target') || '0';
        // if looks like a decimal with dot -> animate float as 1 decimal
        if (raw.indexOf('.') !== -1) {
          animateNumber(el, parseFloat(raw), 900, true);
        } else {
          // treat large revenue numbers specially (format thousands)
          const val = Number(raw);
          // if it's revenue and > 1000, show actual rupees (no divide)
          animateNumber(el, val, 900, false);
        }
      });
    });
  })();
</script>
{% endblock %}
